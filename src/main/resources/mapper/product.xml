<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">

	
	
	<select id="list" resultType="Items">
		SELECT i.*, C.NAME CATEGORY_NAME
		FROM items i join CATEGORIES c ON i.CATEGORY_ID = c.CATEGORY_ID
		WHERE user_id = #{userId} 
		ORDER BY CREATED_AT DESC
	</select>
	
	
	<insert id="add">
		INSERT INTO items(ID, USER_ID, CATEGORY_ID, TITLE, DESCRIPTION, DELIVERY, PRICE, AMOUNT, VIEWS, BANK_ACCOUNT_NUMBER,IS_DIRECT_DEAL)
		values(items_seq.nextval, #{userId}, #{categoryId}, #{title}, #{description}, #{delivery}, #{price}, #{amount}, #{views},#{bankAccountNumber},#{isDirectDeal, jdbcType=VARCHAR})
		
  		 <!-- 현재 시퀀스 값을 유지함 -> 트랜잭션 발동 -->
  		 <selectKey keyProperty="id" resultType="int" order="AFTER">
  		 	SELECT ITEMS_SEQ.currval FROM dual
  		 </selectKey>
	</insert>
	
	<insert id="addWithImage">
		INSERT INTO ITEM_IMAGES (ID, ITEM_ID, IMAGE_URL, SORT_ORDER, FILENAME)
		VALUES (ITEM_IMAGES_SEQ.NEXTVAL, #{itemId}, #{imageUrl}, #{sortOrder}, #{fileName})
	</insert>
	
	<delete id="delete">
		DELETE FROM items
		WHERE id = #{id}
	</delete>
	
	<update id="update">
		UPDATE ITEMS
		SET CATEGORY_ID = #{categoryId}
			, TITLE = #{title}
			, DESCRIPTION = #{description}
			, DELIVERY = #{delivery}
			, PRICE = #{price}
			, AMOUNT = #{amount}
			, BANK_ACCOUNT_NUMBER = #{bankAccountNumber}
			, IS_DIRECT_DEAL = #{isDirectDeal}
		WHERE id=#{id}
	</update>
	
	<select id="item" resultType="Items">
		SELECT * FROM ITEMS
		WHERE ID = #{id}
	</select>
	
	<select id="totalList" resultType="Items">
		SELECT 
			U.ID AS UESR_ID,
			I.ID AS ID,
			U.NICKNAME,
			U.EMAIL,
			U.PHONE,
			I.SALES_STATUS,
			I.CREATED_AT,
			I.CATEGORY_ID,
			I.TITLE,
			I.DESCRIPTION,
			I.DELIVERY,
			I.IS_DIRECT_DEAL,
			I.PRICE,
			I.AMOUNT,
			I.BANK_ACCOUNT_NUMBER,
			I.SALES_STATUS,
			C.NAME CATEGORY_NAME
		FROM USERS U 
		RIGHT JOIN ITEMS I ON (I.USER_ID = U.ID) 
		JOIN CATEGORIES C ON (I.CATEGORY_ID = C.CATEGORY_ID)
		<include refid="search" />
		ORDER BY I.CREATED_AT DESC
	</select>

	<sql id="search">
	    <where>
	        SALES_STATUS = 'available'
	        	<if test="search == 1">
					 AND (TITLE like '%' || #{keyword} || '%' or DESCRIPTION like '%' || #{keyword} || '%')		
				</if>
				<if test="search == 2">
					 AND (NICKNAME like '%' || #{keyword} || '%')
				</if>
	    </where>
	</sql>

	<update id="changeAmount">
		UPDATE ITEMS
		SET AMOUNT = AMOUNT + #{amount}
		WHERE id = #{id}
		<if test="amount &lt; 0">
			AND AMOUNT >= -#{amount}
		</if>
	</update>


	<select id="selectCategory" resultType="Categories">
		select *
		from CATEGORIES
		order by name
	</select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="member">
  
  	<resultMap id="MemberResultMap" type="Member">
        <id property="id" column="ID"/>
        <result property="username" column="USERNAME"/>
        <result property="email" column="EMAIL"/>
        <result property="password" column="PASSWORD"/>
        <result property="phone" column="PHONE"/>
        <result property="userType" column="USER_TYPE"/>
        <result property="loginType" column="LOGIN_TYPE"/>
        <result property="providerId" column="PROVIDER_ID"/>
        <result property="profileImage" column="PROFILE_IMAGE"/>
        <result property="status" column="STATUS"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
        <result property="nickname" column="NICKNAME"/>
    </resultMap>
 
  	<select id="findByEmail" parameterType="String" resultType="Member">

  		SELECT id, username, email, password, phone, created_at, updated_at, nickname
    	FROM USERS
    	WHERE EMAIL = #{email}
  	</select>
  	
  	<insert id="insertMember" parameterType="Member">
  		INSERT INTO USERS (id, username, email, password, phone,
    					   created_at, updated_at, nickname)
  		VALUES (USERS_SEQ.NEXTVAL, #{username}, #{email}, #{password}, #{phone}, #{createdAt, jdbcType=TIMESTAMP}, 
    			#{updatedAt, jdbcType=TIMESTAMP}, #{nickname})
	</insert>
  	
  	<select id="checkId" parameterType="String" resultType="int">
  		SELECT COUNT(*) FROM USERS WHERE EMAIL = #{email}
  	</select>
  	
  	<select id="checkNm" parameterType="String" resultType="int">
  		SELECT COUNT(*) FROM USERS WHERE NICKNAME = #{nickname}
  	</select>
  	
  	<!-- 아이디 찾기 -->
    <select id="findId" parameterType="map" resultType="string">
        SELECT email
        FROM USERS
        WHERE username = #{username}
          AND phone = #{phone}
    </select>
    
    <select id="findPassword" parameterType="map" resultType="string">
    SELECT PASSWORD
    FROM USERS
    WHERE email = #{email}
      AND phone = #{phone}
	</select>
	
	<update id="updatePassword">
	    UPDATE USERS
	    SET password = #{newPassword}
	    WHERE email = #{email}
	</update>
	
	<select id="findById" resultType="Member">
		SELECT ID, EMAIL, NICKNAME, PHONE
		FROM USERS
		WHERE ID = #{id}
	</select>
	
	<!-- mypage 정보 -->
	<select id="myPageInfo" parameterType="int" resultType="com.exam.gagi.model.MypageViewDto">
	  <![CDATA[
    	SELECT
        	u.USERNAME AS username,
        	u.EMAIL AS email,
        	u.PHONE AS phone,
        	u.NICKNAME AS nickname,
        	(SELECT NVL(SUM(TOTAL_PRICE), 0) FROM ORDERS o WHERE o.USER_ID = u.ID AND o.ORDER_STATUS <> '취소') AS totalPurchase,
        	(SELECT NVL(SUM(o.TOTAL_PRICE), 0) FROM ORDERS o JOIN ITEMS i ON o.ITEM_ID = i.ID WHERE i.USER_ID = u.ID AND o.ORDER_STATUS NOT IN ('입금준비', '취소')) AS totalSales
    	FROM
        	USERS u
    	WHERE
        	u.ID = #{id}
	  ]]>
	</select>

  </mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="orders">

    <!-- SQL Fragments for Reusability -->
    <sql id="orderColumns">
        o.ID AS order_id,
        o.USER_ID AS user_id,
        o.TRANSACTION_TYPE AS transaction_type,
        o.TOTAL_PRICE AS order_total_price,
        o.PAYMENT_METHOD AS payment_method,
        o.RECIPIENT_NAME AS recipient_name,
        o.RECIPIENT_PHONE AS recipient_phone,
        o.DELIVERY_ZIPCODE AS delivery_zipcode,
        o.DELIVERY_ADDRESS_MAIN AS delivery_address_main,
        o.DELIVERY_ADDRESS_DETAIL AS delivery_address_detail,
        o.DELIVERY_MEMO AS delivery_memo,
        o.CREATED_AT AS created_at,
        o.UPDATED_AT AS updated_at
    </sql>

    <sql id="orderItemColumns">
        oi.ID AS order_item_id,
        oi.ORDER_ID AS order_item_order_id,
        oi.ITEM_ID AS item_id,
        oi.QUANTITY AS quantity,
        oi.PRICE AS price,
        oi.ORDER_STATUS AS order_item_status,
        oi.CREATED_AT AS order_item_created_at
    </sql>

    <sql id="itemColumns">
        i.ID AS item_id_from_item_table,
        i.USER_ID AS item_user_id,
        i.CATEGORY_ID AS category_id,
        i.TITLE AS item_title,
        i.DESCRIPTION AS description,
        i.DELIVERY AS delivery,
        i.IS_DIRECT_DEAL AS is_direct_deal,
        i.PRICE AS item_price,
        i.AMOUNT AS amount,
        i.BANK_ACCOUNT_NUMBER AS bank_account_number,
        i.SALES_STATUS AS sales_status,
        i.VIEWS AS views,
        i.DELETED_AT AS deleted_at
    </sql>

    <sql id="itemImageThumbnail">
        (SELECT IMAGE_URL FROM item_images ii WHERE ii.item_id = i.id AND ROWNUM = 1) AS image_url
    </sql>

    <sql id="orderItemJoin">
        INNER JOIN ORDER_ITEMS oi ON o.ID = oi.ORDER_ID
    </sql>

    <sql id="itemJoin">
        INNER JOIN ITEMS i ON oi.ITEM_ID = i.ID
    </sql>

    <!-- Insert Statements -->
  	<insert id="add" parameterType="Orders">
  		<selectKey keyProperty="id" resultType="int" order="BEFORE">
  			SELECT ORDERS_SEQ.NEXTVAL FROM DUAL
  		</selectKey>
  		INSERT INTO ORDERS (
            ID, USER_ID, TRANSACTION_TYPE, TOTAL_PRICE, PAYMENT_METHOD,
            RECIPIENT_NAME, RECIPIENT_PHONE, DELIVERY_ZIPCODE, DELIVERY_ADDRESS_MAIN,
            DELIVERY_ADDRESS_DETAIL, DELIVERY_MEMO, CREATED_AT, UPDATED_AT
        ) VALUES (
            #{id}, 
            #{userId}, 
            #{transactionType, jdbcType=VARCHAR}, 
            #{totalPrice}, 
            #{paymentMethod, jdbcType=VARCHAR},
            #{recipientName, jdbcType=VARCHAR}, 
            #{recipientPhone, jdbcType=VARCHAR}, 
            #{deliveryZipcode, jdbcType=VARCHAR}, 
            #{deliveryAddressMain, jdbcType=VARCHAR},
            #{deliveryAddressDetail, jdbcType=VARCHAR}, 
            #{deliveryMemo, jdbcType=VARCHAR}, 
            CURRENT_TIMESTAMP, 
            CURRENT_TIMESTAMP
        )
  	</insert>
  	
    <!-- ResultMaps -->
    <resultMap id="saleOrderMap" type="Orders">
        <id property="id" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="transactionType" column="transaction_type"/>
        <result property="totalPrice" column="order_total_price"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="recipientName" column="recipient_name"/>
        <result property="recipientPhone" column="recipient_phone"/>
        <result property="deliveryZipcode" column="delivery_zipcode"/>
        <result property="deliveryAddressMain" column="delivery_address_main"/>
        <result property="deliveryAddressDetail" column="delivery_address_detail"/>
        <result property="deliveryMemo" column="delivery_memo"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>

        <collection property="orderItems" ofType="OrderItem">
            <id property="id" column="order_item_id"/>
            <result property="orderId" column="order_item_order_id"/>
            <result property="itemId" column="item_id"/>
            <result property="quantity" column="quantity"/>
            <result property="price" column="price"/>
            <result property="orderStatus" column="order_item_status"/>
            <result property="createdAt" column="order_item_created_at"/>
            
            <association property="item" javaType="Items">
                <id property="id" column="item_id"/>
                <result property="userId" column="item_user_id"/>
                <result property="categoryId" column="category_id"/>
                <result property="title" column="item_title"/>
                <result property="description" column="description"/>
                <result property="delivery" column="delivery"/>
                <result property="isDirectDeal" column="is_direct_deal"/>
                <result property="price" column="item_price"/>
                <result property="amount" column="amount"/>
                <result property="bankAccountNumber" column="bank_account_number"/>
                <result property="salesStatus" column="sales_status"/>
                <result property="views" column="views"/>
                <result property="deletedAt" column="deleted_at"/>
            </association>
        </collection>
    </resultMap>

	<resultMap id="orderListMap" type="com.exam.gagi.dto.OrderDetailDto">
        <id property="orderId" column="order_id"/>
        <result property="orderDate" column="order_date"/>
        <collection property="orderItems" ofType="com.exam.gagi.dto.OrderItemDto">
        	<result property="itemId" column="item_id"/>
            <result property="thumbnailUrl" column="image_url"/>
            <result property="itemName" column="item_title"/>
            <result property="quantity" column="quantity"/>
            <result property="totalPrice" column="total_price"/>
            <result property="orderStatus" column="order_status"/>
        </collection>
    </resultMap>

    <resultMap id="saleDetailDtoMap" type="com.exam.gagi.dto.SaleDetailDto">
        <id property="orderId" column="order_id"/>
        <result property="transactionType" column="transaction_type"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="recipientName" column="recipient_name"/>
        <result property="recipientPhone" column="recipient_phone"/>
        <result property="deliveryZipcode" column="delivery_zipcode"/>
        <result property="deliveryAddressMain" column="delivery_address_main"/>
        <result property="deliveryAddressDetail" column="delivery_address_detail"/>
        <result property="deliveryMemo" column="delivery_memo"/>
        <result property="createdAtFormatted" column="created_at_formatted"/>
        <result property="buyerName" column="buyer_name"/>
        <result property="buyerPhone" column="buyer_phone"/>
        <result property="buyerEmail" column="buyer_email"/>
        <result property="saleSubTotal" column="sale_sub_total"/>
        <collection property="orderItems" ofType="com.exam.gagi.dto.OrderItemDto">
            <result property="itemId" column="item_id"/>
            <result property="thumbnailUrl" column="image_url"/>
            <result property="itemName" column="item_title"/>
            <result property="quantity" column="quantity"/>
            <result property="totalPrice" column="total_price"/>
            <result property="orderStatus" column="order_item_status"/>
        </collection>
    </resultMap>

    <!-- Select Statements -->
    <select id="salelist" resultMap="saleOrderMap" parameterType="SaleSearchDto">
        SELECT
            <include refid="orderColumns" />,
            <include refid="orderItemColumns" />,
            <include refid="itemColumns" />
        FROM ORDERS o
        <include refid="orderItemJoin" />
        <include refid="itemJoin" />
        WHERE i.USER_ID = #{sellerId} AND o.ID IN (
            SELECT ID FROM (
                SELECT o_inner.ID, ROWNUM AS rnum FROM (
                    SELECT DISTINCT o_inner2.ID
                    FROM ORDERS o_inner2
                    INNER JOIN ORDER_ITEMS oi_inner2 ON o_inner2.ID = oi_inner2.ORDER_ID
                    INNER JOIN ITEMS i_inner2 ON oi_inner2.ITEM_ID = i_inner2.ID
                    WHERE i_inner2.USER_ID = #{sellerId}
                    ORDER BY o_inner2.ID DESC
                ) o_inner WHERE ROWNUM &lt;= #{pager.page} * #{pager.perPage}
            ) WHERE rnum &gt;= (#{pager.page} - 1) * #{pager.perPage} + 1
        )
        ORDER BY o.CREATED_AT DESC, oi.ID ASC
    </select>
  	
    <select id="orderList" resultMap="orderListMap" parameterType="OrderSearchDto">
        SELECT
            o.ID AS order_id,
            o.CREATED_AT AS order_date,
            oi.ITEM_ID AS item_id,
            <include refid="itemImageThumbnail" />,
            i.TITLE AS item_title,
            oi.QUANTITY AS quantity,
            (oi.QUANTITY * oi.PRICE) AS total_price,
            oi.ORDER_STATUS AS order_status
        FROM
            ORDERS o
        <include refid="orderItemJoin" />
        <include refid="itemJoin" />
        WHERE o.ID IN (
	        SELECT ID FROM (
	            SELECT o_inner.ID, ROWNUM AS rnum FROM (
	                SELECT ID FROM ORDERS WHERE USER_ID = #{userId, jdbcType=NUMERIC} ORDER BY ID DESC
	            ) o_inner WHERE ROWNUM &lt;= #{pager.page} * #{pager.perPage}
	        ) WHERE rnum &gt;= (#{pager.page} - 1) * #{pager.perPage} + 1
        )
        ORDER BY
            o.ID DESC
    </select>
    
    <select id="getTotal" resultType="int" parameterType="string">
    	SELECT COUNT(*) FROM ORDERS WHERE USER_ID = #{userId, jdbcType=NUMERIC}
    </select>
    
    <select id="getSaleTotal" resultType="int" parameterType="string">
    	SELECT COUNT(DISTINCT o.ID) 
    	FROM ORDERS o
        INNER JOIN ORDER_ITEMS oi ON o.ID = oi.ORDER_ID
        INNER JOIN ITEMS i ON oi.ITEM_ID = i.ID
    	WHERE i.USER_ID = #{sellerId, jdbcType=NUMERIC}
    </select>
    
    <select id="getSaleDetail" resultMap="saleDetailDtoMap" parameterType="map">
        SELECT
            o.ID AS order_id,
            o.TRANSACTION_TYPE AS transaction_type,
            o.PAYMENT_METHOD AS payment_method,
            o.RECIPIENT_NAME AS recipient_name,
            o.RECIPIENT_PHONE AS recipient_phone,
            o.DELIVERY_ZIPCODE AS delivery_zipcode,
            o.DELIVERY_ADDRESS_MAIN AS delivery_address_main,
            o.DELIVERY_ADDRESS_DETAIL AS delivery_address_detail,
            o.DELIVERY_MEMO AS delivery_memo,
            TO_CHAR(o.CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS created_at_formatted,

            m.USERNAME AS buyer_name,
            m.PHONE AS buyer_phone,
            m.EMAIL AS buyer_email,

            (SELECT SUM(oi_inner.QUANTITY * i_inner.PRICE)
             FROM ORDER_ITEMS oi_inner
             JOIN ITEMS i_inner ON oi_inner.ITEM_ID = i_inner.ID
             WHERE oi_inner.ORDER_ID = o.ID AND i_inner.USER_ID = #{sellerId}) AS sale_sub_total,

            oi.ID AS order_item_id,
            oi.QUANTITY AS quantity,
            (oi.QUANTITY * oi.PRICE) AS total_price,
            oi.ORDER_STATUS AS order_item_status,
            (SELECT IMAGE_URL FROM item_images ii WHERE ii.item_id = i.id AND ROWNUM = 1) AS image_url,
            i.TITLE AS item_title
        FROM ORDERS o
        INNER JOIN ORDER_ITEMS oi ON o.ID = oi.ORDER_ID
        INNER JOIN ITEMS i ON oi.ITEM_ID = i.ID
        INNER JOIN USERS m ON o.USER_ID = m.ID
        WHERE o.ID = #{orderId} AND i.USER_ID = #{sellerId}
    </select>
  </mapper>
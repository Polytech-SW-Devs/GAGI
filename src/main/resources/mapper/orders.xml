<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="orders">
  	<insert id="add">
  		INSERT INTO ORDERS (
            ID, USER_ID, TRANSACTION_TYPE, ORDER_STATUS, TOTAL_PRICE, PAYMENT_METHOD,
            RECIPIENT_NAME, RECIPIENT_PHONE, DELIVERY_ZIPCODE, DELIVERY_ADDRESS_MAIN,
            DELIVERY_ADDRESS_DETAIL, DELIVERY_MEMO, MEETING_LOCATION, MEETING_DATETIME,
            CONTACT_INFO, CREATED_AT, UPDATED_AT
        ) VALUES (
            ORDERS_SEQ.NEXTVAL, #{userId}, #{transactionType}, #{orderStatus}, #{totalPrice}, #{paymentMethod},
            #{recipientName}, #{recipientPhone}, #{deliveryZipcode}, #{deliveryAddressMain},
            #{deliveryAddressDetail}, #{deliveryMemo}, #{meetingLocation}, #{meetingDateTime},
            #{contactInfo}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
  	</insert>
  	
  	<select id="salelist" resultType="Orders">
  		SELECT * FROM orders
  	</select>
  	


	<resultMap id="orderHistoryMap" type="com.exam.gagi.model.OrderDetailDto">
        <id property="orderId" column="order_id"/>
        <result property="orderDate" column="order_date"/>
        <result property="shippingStatus" column="order_status"/>
        <collection property="orderItems" ofType="com.exam.gagi.model.OrderItemDto">
        	<result property="itemId" column="item_id"/>
            <result property="thumbnailUrl" column="image_url"/>
            <result property="itemName" column="item_title"/>
            <result property="quantity" column="quantity"/>
            <result property="totalPrice" column="total_price"/>
        </collection>
    </resultMap>

    <select id="getDetailedOrderHistory" resultMap="orderHistoryMap" parameterType="string">
        SELECT
            o.ID AS order_id,
            o.CREATED_AT AS order_date,
            o.ORDER_STATUS AS order_status,
            i.ID AS item_id,
            i.TITLE AS item_title,
            (SELECT IMAGE_URL FROM item_images ii WHERE ii.item_id = i.id AND ROWNUM = 1) AS image_url,
            oi.QUANTITY AS quantity,
            (oi.QUANTITY * oi.PRICE) AS total_price
        FROM
            ORDERS o
        INNER JOIN
            ORDER_ITEMS oi ON o.ID = oi.ORDER_ID
        INNER JOIN
            ITEMS i ON oi.ITEM_ID = i.ID
        WHERE
            o.USER_ID = #{userId}
        ORDER BY
            o.ID DESC
    </select>
  </mapper>


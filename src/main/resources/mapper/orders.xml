<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="orders">


	<select id="orderTotal" resultType="Integer">
  		SELECT COUNT(*)
  		FROM ORDERS
  		WHERE USER_ID = #{userId} 
  	</select>
  	
  	
  	<select id="saleTotal" resultType="Integer">
    	SELECT COUNT(*)
    	FROM ORDERS o
    	JOIN ITEMS i ON o.ITEM_ID = i.ID
    	WHERE i.USER_ID = #{userId}
	</select>
  	
  	<select id="orderList" resultType="Orders">
	    SELECT *
	    FROM (
	        SELECT 
	            o.*,                       <!-- ORDERS 모든 컬럼 자동 매핑 -->
	            i.TITLE AS title,          <!-- Orders.title -->
	            img.IMAGE_URL AS imageUrl, <!-- Orders.imageUrl -->
	            ROW_NUMBER() OVER(ORDER BY o.CREATED_AT DESC) AS rnum
	        FROM ORDERS o
	        LEFT JOIN ITEMS i ON o.ITEM_ID = i.ID
	        LEFT JOIN ITEM_IMAGES img 
	               ON o.ITEM_ID = img.ITEM_ID 
	              AND img.SORT_ORDER = 1      <!-- 첫 번째 이미지만 가져오기 -->
	        WHERE o.USER_ID = #{userId}
	    ) t
	    WHERE t.rnum BETWEEN ((#{page}-1) * #{perPage}) + 1
	                      AND (#{page} * #{perPage})
	</select>
  	
  	<select id="saleList" resultType="Orders">
	    SELECT *
	    FROM (
	        SELECT 
	            o.*,                       <!-- ORDERS 모든 컬럼 자동 매핑 -->
	            i.TITLE AS title,          <!-- Orders.title -->
	            img.IMAGE_URL AS imageUrl, <!-- Orders.imageUrl -->
	            ROW_NUMBER() OVER(ORDER BY o.CREATED_AT DESC) AS rnum
	        FROM ORDERS o
	        LEFT JOIN ITEMS i 
	               ON o.ITEM_ID = i.ID
	              AND i.USER_ID = #{userId}    <!-- 판매자 필터 -->
	        LEFT JOIN ITEM_IMAGES img 
	               ON o.ITEM_ID = img.ITEM_ID 
	              AND img.SORT_ORDER = 1      <!-- 첫 번째 이미지 -->
	    ) t
	    WHERE t.rnum BETWEEN ((#{page}-1) * #{perPage}) + 1
	                      AND (#{page} * #{perPage})
	</select>
  	
 </mapper>

